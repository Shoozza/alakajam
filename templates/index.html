
{% extends "_page.html" %}
{% import "event/_macros-event.html" as eventMacros %}
{% import "post/_macros-post.html" as postMacros %}
{% import "user/_macros-user.html" as userMacros %}
{% import "_macros-form.html" as formMacros %}

{% block body %}


<!-- SPARKLES -->
<canvas id='canv' style="position: absolute; top: 0; left: 0"></canvas>
<img id="particle" src="./static/images/particle.png" style="width: 1px; height: 1px" />
<script type="text/javascript">
var c = document.getElementById('canv'), 
    $$ = c.getContext("2d");
var w = c.width = window.innerWidth, 
    h = c.height = window.innerHeight;
var particle = document.getElementById("particle")

Snowy();
function Snowy() {
  var snow, arr = [];
  var num = 10, tsc = 1, sp = 0;
  var sc = 2.5, t = 0, mv = 3, min = 0;
    for (var i = 0; i < num; ++i) {
      snow = new Flake();
      snow.y = Math.random() * (h + 50);
      snow.x = Math.random() * w;
      snow.t = Math.random() * (Math.PI * 2);
      snow.sz = (100 / (10 + (Math.random() * 100))) * sc;
      snow.sp = (Math.pow(snow.sz * .8, 2) * .15) * sp;
      snow.sp = snow.sp < min ? min : snow.sp;
      arr.push(snow);
    }
  go();
  function go(){
    window.requestAnimationFrame(go);
      $$.clearRect(0, 0, w, h);
      $$.fill();
        for (var i = 0; i < arr.length; ++i) {
          f = arr[i];
          f.t += .05;
          f.t = f.t >= Math.PI * 2 ? 0 : f.t;
          f.y += f.sp;
          f.x += Math.sin(f.t * tsc) * (f.sz * .1);
          if (f.y > h + 50) f.y = -10 - Math.random() * mv;
          if (f.x > w + mv) f.x = - mv;
          if (f.x < - mv) f.x = w + mv;
          f.draw();
        }
 }
 function Flake() {
   this.draw = function() {
      $$.moveTo(this.x, this.y);
      $$.drawImage(particle, this.x, this.y);
    }
  }
}
/*________________________________________*/
window.addEventListener('resize', function(){
  c.width = w = window.innerWidth;
  c.height = h = window.innerHeight;
}, false);
</script>
<style type="text/css">
body {
  background-image: url('./static/images/superbg.jpg');
  background-size: cover;
  background-repeat: no-repeat;
}
</style>

<div class="container">
  <div class="row">
    {% if not user %}
    <div class="home-welcome">
      <img class="home-welcome__icon" src="/static/images/welcome.png" />
      <div class="home-welcome__title">New website unlocked</div>
       Welcome to <div class="home-welcome__brand">Wingardium Leviojam!</div>, a game development community. We host informal game jams!
       <a class="home-welcome__more" href="/article/docs">Learn&nbsp;more</a>
    </div>
    {% endif %}

    {% if featuredPost %}
    <div class="col-lg-offset-1 col-lg-10">
      {{ postMacros.post(featuredPost, user) }}
    </div>
    {% endif %}
  </div>

  <div class="row">
    <div class="col-md-9">
      {% if featuredEvent %}
      <div class="home-jumbo {{ featuredEvent.get('status') }}">
        <div class="event-table">
          <div class="event-table__header">
            <a href="{{ buildUrl(featuredEvent, 'event') }}" class="event-table__title">
              {{ featuredEvent.get('title') }}
              <div class="event-table__dates">
                {{ featuredEvent.get('display_dates') or '(dates unknown)' }}
              </div>
            </a>
            {% if featuredEvent.get('display_theme') %}
            <div class="event-table__theme hidden-xs">
              <span class="event-table__theme-label">Theme</span>
              {{ featuredEvent.get('display_theme') }}
            </div>
            {% endif %}
          </div>
          <div class="event-table__theme-mobile visible-xs">
            Theme: {{ featuredEvent.get('display_theme') }}
          </div>
        </div>

        <div class="home-jumbo__call-container">
        {% set rawHypeLink = featuredEvent.get('countdown_config').link %}
        {% set animatedCountdown = featuredEvent.get('countdown_config').enabled %}
        {% if rawHypeLink %}
          {% set hypeLink = rawHypeLink if rawHypeLink.indexOf('/') !== -1 else buildUrl(featuredEvent, 'event', rawHypeLink) %}
          <a class="home-jumbo__call" href="{{ hypeLink }}">
            <div class="row">
              <div class="col-xs-11 {{ 'col-md-6' if animatedCountdown }}">
                <h2>{{ featuredEvent.get('countdown_config').message }}</h2>
                {% if featuredEvent.get('countdown_config').phrase %}
                  <span class="glyphicon glyphicon-calendar"></span> {{ featuredEvent.get('countdown_config').phrase }} {{ featuredEvent.get('countdown_config').date | featuredEventDateTime }}
                {% endif %}
              </div>
            </div>
            {% if animatedCountdown %}
              <span class="home-jumbo__countdown js-countdown"></span>
            {% endif %}
            <span class="fa fa-angle-right home-jumbo__call-arrow"></span>
          </a>
        {% elseif featuredEvent.get('countdown_config').phrase %}
          <div class="home-jumbo__details">
            <div class="row">
              <div class="col-xs-11 {{ 'col-md-6' if animatedCountdown }}">
                {% if featuredEvent.get('countdown_config').phrase %}
                  <span class="glyphicon glyphicon-calendar"></span> {{ featuredEvent.get('countdown_config').phrase }} {{ featuredEvent.get('countdown_config').date | featuredEventDateTime }}
                {% endif %}
              </div>
              {% if animatedCountdown %}
                <div class="col-md-6">
                  <span class="home-jumbo__countdown js-countdown"></span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
        </div>

        {% if user and featuredEvent and featuredEvent.get('status_entry') !== 'off' %}
          {{ eventMacros.eventShortcutMyEntry(user, featuredEvent, userEntry) }}
        {% endif %}
      </div>

      <div class="home-jumbo__contents">
        {% if featuredEventAnnouncement %}
          <div class="home-jumbo__announcement expandable">
            {{ postMacros.post(featuredEventAnnouncement, user, { hideDate: true }) }}
            {{ formMacros.expandCollapse({ manualScripting: true }) }}
          </div>
          <script type="text/javascript">
            // Custom announcement height limit and expand/collapse button
            // Script inlined for fast loading
            var maxAnnouncementHeight = 350
            var announcementEl = findByClass('home-jumbo__announcement')
            if (announcementEl.offsetHeight > maxAnnouncementHeight + 50) {
              announcementEl.setAttribute('style', 'max-height: ' + maxAnnouncementHeight + 'px')
              var expandBarEl = findByClass('expand-bar', 'home-jumbo__announcement')
              expandBarEl.setAttribute('style', 'display: block')
              expandBarEl.onclick = function (e) {
                if (announcementEl.className.indexOf('expanded') !== -1) {
                  announcementEl.className = announcementEl.className.replace(' expanded', '')
                } else {
                  announcementEl.className += ' expanded'
                }
                e.preventDefault()
                return false
              }
            } else {
              findByClass('expand-bar', 'home-jumbo__announcement').remove()
            }
            
            function findByClass(className, parentClassName) {
              var parent = parentClassName ? findByClass(parentClassName) : document
              var elements = parent.getElementsByClassName(className)
              return (elements.length > 0) ? elements[0] : null
            }
          </script>
        {% endif %}

        <!-- XXX Hard-coded temporary DanaePlays stream -->
        {% set shortlistEliminationInfo = featuredEvent.related('details').get('shortlist_elimination') %}
        {% if shortlistEliminationInfo.delay %}
        <div style="margin-bottom: 20px; box-shadow: 2px 2px 2px #DDD">
          <div id="twitch-embed"></div>
        </div>
        <script src="https://embed.twitch.tv/embed/v1.js"></script>
        <script type="text/javascript">
          new Twitch.Embed("twitch-embed", {
            width: '100%',
            height: 400,
            channel: "DanaePlays"
          });
        </script>
        {% endif %}
      </div>
      {% endif %}

      {% if not featuredEvent and not featuredPost %}
        <h1 class="text-center">Next event not announced yet.</h1>
      {% endif %}

      <div class="home-jumbo__social">
        {{ socialLink('Twitter', 'https://twitter.com/AlakajamBang', 'twitter.svg') }}
        {{ socialLink('Reddit', 'https://www.reddit.com/r/alakajam', 'reddit.svg') }}
        {{ socialLink('IRC', '/chat', 'irc.svg') }}
        {{ socialLink('Twitch', 'https://www.twitch.tv/communities/alakajam', 'twitch.png') }}
        {{ socialLink('YouTube', 'https://www.youtube.com/channel/UCaIXjxJWGYQs7x_1d1OZi6Q/videos', 'youtube.svg') }}
        {{ socialLink('Github', 'https://github.com/alakajam-team', 'github.svg') }}
      </div>
    </div>
    
    <div class="col-md-3">
  
      {% if featuredLinks %}
        <div class="home-featured-links">
          <div class="horizontal-bar" style="margin-top: 0px; margin-bottom: 10px">
            <span class="fa fa-info-circle"></span>
            Special pages
          </div>
        {% for featuredLink in featuredLinks %}
          <a class="home-featured-link" href="{{ featuredLink.link }}">
            <span class="fa {{ featuredLink.icon }}"></span>
            <span class="home-featured-link__title">{{ featuredLink.title }}</span>
          </a>
        {% endfor %}
        </div>
      {% endif %}

      <div class="home-scheduled-events visible-md visible-lg">
        <div class="horizontal-bar" style="margin-top: 0px; margin-bottom: 10px">
          <span class="fa fa-calendar"></span>
          Event calendar
        </div>

        {% for event in eventSchedule %}
          {% set mainEvent = event.get('title').includes('Alakajam') %}
          <div class="home-scheduled-event {{ 'featured' if featuredEvent and featuredEvent.get('id') === event.get('id') }} {{ 'main' if mainEvent }}">
            <div class="home-scheduled-event__arrow"></div>
            <a class="home-scheduled-event__title" href="{{ buildUrl(event, 'event', 'results' if event.get('status_results') === 'results') }}">
              {% if mainEvent %}
                <img src="/static/images/favicon16.png" class="home-scheduled-event__logo no-border" />
              {% endif %}
              {{ event.get('title') }}
            </a>
            <div class="home-scheduled-event__dates">
              {{ event.get('display_dates') }} 
              {% if event.get('status') === 'closed' %}
                - <a href="{{ buildUrl(event, 'event') }}">{{ event.get('entry_count') }} games</a>
              {% endif %}
            </div>
            <div class="home-scheduled-event__label">
              {% if event.get('status') === 'open' %}
                <span class="label label-danger">On now!</span>
              {% elseif event.get('status') === 'pending' %}
                <span class="label label-default">Up next!</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        <div class="home-scheduled-event">
          <a class="home-scheduled-event__title" href="/events">More...</a>
        </div>
      </div>
    </div>
  </div>
  
  {% if suggestedEntries and suggestedEntries.length > 0 %}
  <div class="row">
    <div class="col-xs-12">
      <div class="horizontal-bar">
        Suggested entries to rate {{ formMacros.tooltip('Rate and comment other games to increase your Feedback Score. The Top 4 are featured on the front page!') }}
      </div>
      <div class="row">
      {% for entry in suggestedEntries %}
        <div class="home-entry col-sm-4 col-md-3">
        {{ eventMacros.entryThumb(entry) }}
        </div>
      {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
    
  {% if posts.length > 0 %}
  <div class="row">
    <div class="col-lg-offset-1 col-lg-10">
        <div class="horizontal-bar">Latest posts</div>

        {{ eventMacros.eventShortcutMyPost(user, featuredEvent, userPost) if user and featuredEvent }}
        <div class="spacing"></div>

        {% for post in posts %}
          <div class="expandable">
            {{ postMacros.post(post, user) }}
            {{ formMacros.expandCollapse() }}
          </div>
        {% endfor %}
        {{ formMacros.pagination(1, pageCount, '/posts') }}
    </div>
  </div>
  {% endif %}
</div>

{% endblock %}


{% macro jumboLink (event, statusField, targetPath, label, icon, closedValues = [], options = {}) %}
{% if not statusField or event.get(statusField) !== 'disabled' %}
  <a href="{{ targetPath if options.absoluteUrl else buildUrl(event, 'event', targetPath) }}" 
      class="home-jumbo__link {{ 'disabled' if statusField and closedValues.includes(event.get(statusField)) else 'active' }}">
    <div class="panel home-jumbo__link-border">
      <span class="glyphicon glyphicon-{{ icon }}"></span> 
      <span class="home-jumbo__link-label">{{ label }}{% if options.count %}<span class="count"> ({{ options.count }})</span>{% endif %}</span>
    </div>
  </a>
{% endif %}
{% endmacro %}


{% macro socialLink (title, url, iconName) %}
  <a href="{{ url }}" class="footer__link has-tooltip" data-toggle="tooltip" data-original-title="{{ title }}">
    <img src="/static/images/social/{{ iconName }}" class="footer__icon no-border" /> 
  </a>
{% endmacro %}


{% block scripts %}
{{ formMacros.expandCollapseScripts() }}

{% if featuredEvent and featuredEvent.get('countdown_config').enabled %}
  <script type="text/javascript" src="/static/js/flipclock.min.js"></script>
  <script type="text/javascript">
    alakajam.countdown('.js-countdown', {{ featuredEvent.get('countdown_config').date | jsonInsideScriptTag }});
  </script>
{% endif %}

{% endblock %}

