<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/entry-importers/itch.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/entry-importers/itch.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

/**
 * itch.io entry importer
 *
 * @module services/entry-importers/itch
 */

const download = require('download')
const cheerio = require('cheerio')
const log = require('../../core/log')
const forms = require('../../core/forms')

module.exports = {
  config: {
    id: 'itch.io',
    title: 'Itch.io',
    mode: 'oauth',
    oauthUrl: 'https://itch.io/user/oauth?client_id=5cdadb611825c8421a9b4872d392e227&amp;scope=profile%3Agames&amp;response_type=token&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob'
  },
  fetchEntryReferences,
  fetchEntryDetails
}

async function fetchEntryReferences (profileIdentifier) {
  let myGamesApiUrl = `https://itch.io/api/1/${profileIdentifier}/my-games`

  let data
  try {
    data = JSON.parse(await download(myGamesApiUrl))
  } catch (e) {
    log.warn('Failed to download ' + myGamesApiUrl)
    console.log(e)
    return { error: 'Failed to call itch.io API' }
  }

  if (data.errors) {
    return { error: data.errors.join(', ') }
  }

  let entryReferences = []
  if (Array.isArray(data.games)) {
    for (let entry of data.games) {
      entryReferences.push({
        id: entry.id.toString(),
        title: entry.title,
        link: entry.url,
        thumbnail: entry.cover_url,
        importerProperties: {
          published: entry.published_at,
          links: [{
            url: entry.url,
            label: 'Play the game'
          }],
          description: entry.short_text
        }
      })
    }
  }
  return entryReferences
}

async function fetchEntryDetails (entryReference) {
  let entryDetails = Object.assign({}, entryReference, entryReference.importerProperties)

  // Fetch additional info from actual game page
  let rawPage
  try {
    rawPage = await download(entryReference.link)
  } catch (e) {
    log.warn('Failed to download ' + entryReference.link)
    console.log(e)
    return []
  }
  let $ = cheerio.load(rawPage.toString())

  // Event title
  let $jamEntryLinks = $('li.jam_entry')
  if ($jamEntryLinks.length > 0) {
    entryDetails.externalEvent = $($jamEntryLinks.get(0)).text().replace('View submission for ', '')
  }

  // Detailed description
  let detailedDescriptionHtml = $('.formatted_description').html()
  entryDetails.body = forms.htmlToMarkdown(detailedDescriptionHtml)

  // Large picture
  entryDetails.picture = $('.screenshot_list a').attr('href') || entryDetails.thumbnail

  // Platforms (the API also has information but it's incomplete as HTML5 is missing)
  let platforms = []
  $('.game_info_panel_widget tr').each(function (i, elem) {
    let $rowCells = $(elem).find('td')
    if ($rowCells.length > 0 &amp;&amp; $($rowCells.get(0)).text() === 'Platforms') {
      $(elem).find('a').each(function (i, elem2) {
        let platformId = $(elem2).attr('href').replace(/.*\/platform-/g, '')
        switch (platformId) {
          case 'windows':
            platforms.push('Windows')
            break
          case 'osx':
            platforms.push('Mac')
            break
          case 'linux':
            platforms.push('Linux')
            break
          case 'ios':
          case 'android':
            platforms.push('Mobile')
            break
          case 'html5':
            platforms.push('Web')
            break
        }
      })
    }
  })
  entryDetails.platforms = platforms

  return entryDetails
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core_cache.html">core/cache</a></li><li><a href="module-core_constants.html">core/constants</a></li><li><a href="module-core_db.html">core/db</a></li><li><a href="module-core_enums.html">core/enums</a></li><li><a href="module-core_file-storage.html">core/file-storage</a></li><li><a href="module-core_forms.html">core/forms</a></li><li><a href="module-core_log.html">core/log</a></li><li><a href="module-core_middleware.html">core/middleware</a></li><li><a href="module-core_models.html">core/models</a></li><li><a href="module-services_entry-importers_entry-importers-tools.html">services/entry-importers/entry-importers-tools</a></li><li><a href="module-services_entry-importers_itch.html">services/entry-importers/itch</a></li><li><a href="module-services_entry-importers_ldjam.html">services/entry-importers/ldjam</a></li><li><a href="module-services_entry-importers_ludumdare.html">services/entry-importers/ludumdare</a></li><li><a href="module-services_event-import-service.html">services/event-import-service</a></li><li><a href="module-services_event-rating-service.html">services/event-rating-service</a></li><li><a href="module-services_event-service.html">services/event-service</a></li><li><a href="module-services_event-theme-service.html">services/event-theme-service</a></li><li><a href="module-services_event-tournament-service.html">services/event-tournament-service</a></li><li><a href="module-services_highscore-service.html">services/highscore-service</a></li><li><a href="module-services_like-service.html">services/like-service</a></li><li><a href="module-services_mail-service.html">services/mail-service</a></li><li><a href="module-services_notification-service.html">services/notification-service</a></li><li><a href="module-services_platform-service.html">services/platform-service</a></li><li><a href="module-services_post-service.html">services/post-service</a></li><li><a href="module-services_security-service.html">services/security-service</a></li><li><a href="module-services_setting-service.html">services/setting-service</a></li><li><a href="module-services_user-service.html">services/user-service</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createTag">createTag</a></li><li><a href="global.html#fetchById">fetchById</a></li><li><a href="global.html#fetchByIds">fetchByIds</a></li><li><a href="global.html#searchTags">searchTags</a></li><li><a href="global.html#updateEntryTags">updateEntryTags</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Mar 08 2019 09:19:55 GMT+0100 (Paris, Madrid)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
