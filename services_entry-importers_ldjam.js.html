<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/entry-importers/ldjam.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/entry-importers/ldjam.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

/**
 * ldjam.com entry importer
 *
 * @module services/entry-importers/ldjam
 */

const download = require('download')
const log = require('../../core/log')
const forms = require('../../core/forms')
const enums = require('../../core/enums')
const cache = require('../../core/cache')
const leftPad = require('left-pad')
const entryImporterTools = require('./entry-importer-tools')

module.exports = {
  config: {
    id: 'ldjam.com',
    title: 'Ludum Dare (ldjam.com)',
    mode: 'scraping'
  },
  fetchEntryReferences,
  fetchEntryDetails
}

async function fetchEntryReferences (profileIdentifier) {
  let profileName
  if (profileIdentifier.includes('://')) {
    profileName = profileIdentifier.replace(/\/$/, '').replace(/^.*\//, '')
  } else {
    profileName = profileIdentifier
  }

  // Fetch user ID
  let profileId = null
  try {
    let rawPage = await download(`https://api.ldjam.com/vx/node/walk/1/users/${profileName}`)
    let userIdInfo = JSON.parse(rawPage)
    if (userIdInfo.path &amp;&amp; userIdInfo.path.length === 2) {
      profileId = userIdInfo.path[1]
    }
  } catch (e) {
    log.warn('Failed to download user info')
    console.warn(e)
    return { error: 'Failed to download user info' }
  }
  if (profileId === null) {
    return { error: 'Unknown user name' }
  }

  // Fetch user entry IDs
  // XXX No support for >25 games
  let userEntriesUrl = `https://api.ldjam.com/vx/node/feed/${profileId}/authors/item/game?limit=25`
  let entriesIds = null
  try {
    let rawPage = await download(userEntriesUrl)
    let entriesInfo = JSON.parse(rawPage)
    if (entriesInfo.feed) {
      entriesIds = entriesInfo.feed.map(node => node.id)
    }
  } catch (e) {
    log.warn('Failed to download user game IDs')
    console.warn(e)
    return { error: 'Failed to download user game IDs' }
  }
  if (entriesIds === null) {
    return { error: 'No game IDs data found' }
  }

  // Fetch entry info
  let entryNodesUrl = 'https://api.ldjam.com/vx/node/get/' + entriesIds.join('+')
  let entriesData = null
  try {
    let rawPage = await download(entryNodesUrl)
    let data = JSON.parse(rawPage)
    if (data.node) {
      entriesData = data.node
    }
  } catch (e) {
    log.warn('Failed to download user games')
    console.warn(e)
    return { error: 'Failed to download user games' }
  }
  if (entriesData === null) {
    return { error: 'No game data found' }
  }

  // Build entry references
  let entryReferences = []
  for (let game of entriesData) {
    // Path format: "/events/ludum-dare/[number]/game-name"
    let pathTokens = game.path.split('/')
    let eventName = entryImporterTools.capitalizeAllWords(pathTokens[2].replace(/-/g, ' ')) + ' ' + pathTokens[3]
    let thumbnailPicture = _replaceTripleSlashes(game.meta.cover)

    entryReferences.push({
      id: 'ldjam-' + profileName + '-' + game.id,
      title: forms.sanitizeString(game.name),
      link: 'https://ldjam.com' + game.path,
      thumbnail: forms.isURL(thumbnailPicture) ? thumbnailPicture : null,
      importerProperties: {
        externalEvent: forms.sanitizeString(eventName),
        published: game.published,
        meta: game.meta,
        body: forms.sanitizeMarkdown(game.body)
      }
    })
  }

  return entryReferences
}

async function fetchEntryDetails (entryReference) {
  // Transform links data
  let meta = entryReference.importerProperties.meta
  let tagNames = await _fetchLDJamTagNames()
  let links = []
  for (let linkNumber = 1; linkNumber &lt; 20; linkNumber++) {
    let linkKey = 'link-' + leftPad(linkNumber, 2, '0')
    if (meta[linkKey]) {
      let label = meta[linkKey + '-name'] || tagNames[meta[linkKey + '-tag']]
      if (label) {
        links.push({
          url: meta[linkKey],
          label
        })
      }
    }
  }

  // Guess platforms
  let linksText = links.map(link => link.label).join(' ')
  let platforms = entryImporterTools.guessPlatforms(linksText)

  // Build entry details
  links.push({
    label: 'Ludum Dare entry page',
    url: entryReference.link
  })
  let entryDetails = {
    title: entryReference.title,
    externalEvent: entryReference.importerProperties.externalEvent,
    published: entryReference.importerProperties.published,
    picture: entryReference.thumbnail,
    body: _replaceTripleSlashes(entryReference.importerProperties.body),
    division: meta.author.length > 1 ? enums.DIVISION.TEAM : enums.DIVISION.SOLO,
    platforms,
    links
  }

  return entryDetails
}

function _replaceTripleSlashes (string) {
  return string ? string.replace(/\/\/\//g, 'https://static.jam.vg/') : string
}

async function _fetchLDJamTagNames () {
  return cache.getOrFetch(cache.entryImport, 'ldjamtagnames', async function () {
    try {
      let rawPage = await download('https://api.ldjam.com/vx/tag/get/platform')
      let tags = JSON.parse(rawPage).tag
      let platforms = {}
      tags.forEach(tag => {
        platforms[tag.id] = tag.name
      })
      return platforms
    } catch (e) {
      return { error: 'Failed to download platforms data' }
    }
  })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-core_cache.html">core/cache</a></li><li><a href="module-core_constants.html">core/constants</a></li><li><a href="module-core_db.html">core/db</a></li><li><a href="module-core_enums.html">core/enums</a></li><li><a href="module-core_file-storage.html">core/file-storage</a></li><li><a href="module-core_forms.html">core/forms</a></li><li><a href="module-core_log.html">core/log</a></li><li><a href="module-core_middleware.html">core/middleware</a></li><li><a href="module-core_models.html">core/models</a></li><li><a href="module-services_entry-importers_entry-importers-tools.html">services/entry-importers/entry-importers-tools</a></li><li><a href="module-services_entry-importers_itch.html">services/entry-importers/itch</a></li><li><a href="module-services_entry-importers_ldjam.html">services/entry-importers/ldjam</a></li><li><a href="module-services_entry-importers_ludumdare.html">services/entry-importers/ludumdare</a></li><li><a href="module-services_event-import-service.html">services/event-import-service</a></li><li><a href="module-services_event-rating-service.html">services/event-rating-service</a></li><li><a href="module-services_event-service.html">services/event-service</a></li><li><a href="module-services_event-theme-service.html">services/event-theme-service</a></li><li><a href="module-services_event-tournament-service.html">services/event-tournament-service</a></li><li><a href="module-services_highscore-service.html">services/highscore-service</a></li><li><a href="module-services_like-service.html">services/like-service</a></li><li><a href="module-services_mail-service.html">services/mail-service</a></li><li><a href="module-services_notification-service.html">services/notification-service</a></li><li><a href="module-services_platform-service.html">services/platform-service</a></li><li><a href="module-services_post-service.html">services/post-service</a></li><li><a href="module-services_security-service.html">services/security-service</a></li><li><a href="module-services_setting-service.html">services/setting-service</a></li><li><a href="module-services_user-service.html">services/user-service</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createTag">createTag</a></li><li><a href="global.html#fetchById">fetchById</a></li><li><a href="global.html#fetchByIds">fetchByIds</a></li><li><a href="global.html#searchTags">searchTags</a></li><li><a href="global.html#updateEntryTags">updateEntryTags</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Mar 08 2019 09:19:55 GMT+0100 (Paris, Madrid)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
